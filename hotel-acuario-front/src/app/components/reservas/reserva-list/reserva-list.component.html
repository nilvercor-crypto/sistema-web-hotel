<mat-card>
    <mat-card-title>Reservas</mat-card-title>
    <mat-card-subtitle>Gestión de reservas</mat-card-subtitle>

    <div class="actions">
        <mat-form-field appearance="outline">
            <mat-label>Buscar</mat-label>
            <input matInput (keyup)="applyFilter($any($event.target).value)"
                placeholder="Cliente, habitación..." />
            <button mat-icon-button matSuffix aria-label="Clear" (click)="applyFilter('')">
                <mat-icon>close</mat-icon>
            </button>
        </mat-form-field>

        <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="filtroEstado" (selectionChange)="onEstadoFilterChange()">
                <mat-option *ngFor="let estado of estados" [value]="estado.value">
                    {{ estado.label }}
                </mat-option>
            </mat-select>
        </mat-form-field>

        <button mat-icon-button matTooltip="Actualizar lista" (click)="cargarReservas()" color="primary">
            <mat-icon>refresh</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="nuevo()">
            <mat-icon>add</mat-icon> Nuevo
        </button>
    </div>

    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando reservas...</p>
    </div>

    <div class="table-wrap" *ngIf="!loading">
        <table mat-table [dataSource]="dataSource" matSort matSortDisableClear class="mat-elevation-z1">
            <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
                <td mat-cell *matCellDef="let r">{{ r.id }}</td>
            </ng-container>

            <ng-container matColumnDef="cliente">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
                <td mat-cell *matCellDef="let r">
                    {{ r.clienteNombre }} {{ r.clienteApellido }}
                </td>
            </ng-container>

            <ng-container matColumnDef="habitacion">
                <th mat-header-cell *matHeaderCellDef> Habitación </th>
                <td mat-cell *matCellDef="let r">
                    {{ r.habitacionNumero }} - {{ r.habitacionTipo }}
                </td>
            </ng-container>

            <ng-container matColumnDef="fechas">
                <th mat-header-cell *matHeaderCellDef> Fechas </th>
                <td mat-cell *matCellDef="let r">
                    {{ r.fechaIngreso | date:'shortDate' }} - {{ r.fechaSalida | date:'shortDate' }}
                </td>
            </ng-container>

            <ng-container matColumnDef="servicios">
                <th mat-header-cell *matHeaderCellDef> Servicios </th>
                <td mat-cell *matCellDef="let r">
                    <mat-chip *ngIf="getServiciosCount(r) > 0" [matTooltip]="getServiciosTooltip(r)">
                        {{ getServiciosCount(r) }} servicio(s)
                    </mat-chip>
                    <span *ngIf="getServiciosCount(r) === 0" class="sin-servicios">-</span>
                </td>
            </ng-container>

            <ng-container matColumnDef="montoTotal">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                <td mat-cell *matCellDef="let r">
                    <strong>S/ {{ r.montoTotal | number:'1.2-2' }}</strong>
                </td>
            </ng-container>

            <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
                <td mat-cell *matCellDef="let r">
                    <mat-chip [color]="getEstadoColor(r.estado)">
                        {{ r.estado }}
                    </mat-chip>
                </td>
            </ng-container>

            <ng-container matColumnDef="acciones">
                <th mat-header-cell *matHeaderCellDef> Acciones </th>
                <td mat-cell *matCellDef="let r">
                    <button mat-icon-button 
                            aria-label="Confirmar" 
                            (click)="confirmar(r)" 
                            color="primary"
                            *ngIf="puedeConfirmar(r.estado)"
                            matTooltip="Confirmar reserva">
                        <mat-icon>check_circle</mat-icon>
                    </button>
                    <button mat-icon-button 
                            aria-label="Cancelar" 
                            (click)="cancelar(r)" 
                            color="warn"
                            *ngIf="puedeCancelar(r.estado)"
                            matTooltip="Cancelar reserva">
                        <mat-icon>cancel</mat-icon>
                    </button>
                    <button mat-icon-button 
                            aria-label="Finalizar" 
                            (click)="finalizar(r)" 
                            color="accent"
                            *ngIf="puedeFinalizar(r.estado)"
                            matTooltip="Finalizar reserva">
                        <mat-icon>done_all</mat-icon>
                    </button>
                    <button mat-icon-button 
                            aria-label="Editar" 
                            (click)="editar(r)" 
                            color="primary"
                            *ngIf="r.estado === 'PENDIENTE'"
                            matTooltip="Editar reserva">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button 
                            aria-label="Eliminar" 
                            (click)="eliminar(r)" 
                            color="warn"
                            matTooltip="Eliminar reserva">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
    </div>

    <mat-paginator [pageSize]="10" [pageSizeOptions]="[5,10,25]" showFirstLastButtons></mat-paginator>
</mat-card>
